{{ $ctx := .Context }}
{{ $currentPath := .CurrentPath }}
{{ $re := "\\[([^\\]]+)\\]\\(([^)]+).md\\)" }}


<h2 class="px-2 text-xl text-neutral-500">Navigation</h2>
<div class="mt-4 space-y-3 text-sm text-neutral-600">
  {{ with site.Menus.main }}
    <ul class="space-y-2">
      {{ range . }}
        {{ $isOpen := false }}
        {{ $matches := findRESubmatch $re .Page.RawContent }}
        {{ range $matches }}
          {{ $linkURL := index . 2 }}
          {{ $page := index (where site.RegularPages "File.BaseFileName" $linkURL) 0 }}
          {{ $isOpen = or $isOpen (eq (urls.Parse $page.RelPermalink).Path $currentPath) }}
        {{ end }}
        <li>
          <details
            class="group overflow-hidden rounded-xl border border-neutral-200 bg-white/80"
            {{ if $isOpen }}open{{ end }}
          >
            <summary
              class="flex cursor-pointer items-center justify-between gap-2 px-3 py-2 text-neutral-800 transition hover:text-neutral-600 [&::-webkit-details-marker]:hidden"
            >
              <span class="flex items-center gap-2">
                <svg
                  class="h-4 w-4 shrink-0 text-neutral-400 transition-transform duration-200 group-open:rotate-90"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18l6-6-6-6" />
                </svg>
                <span class="truncate">{{ .Name }}</span>
              </span>
            </summary>

            <ul
              class="space-y-1 border-t border-neutral-200 bg-white/70 py-2 pl-4"
            >
              {{ range $matches }}
                {{ $linkText := index . 1 }}
                {{ $linkURL := index . 2 }}
                {{ $page := index (where site.RegularPages "File.BaseFileName" $linkURL) 0 }}
                {{ $active := eq (urls.Parse $page.RelPermalink).Path $currentPath }}
                {{ with $page }}
                  <li>
                    <a
                      href="{{ .RelPermalink }}"
                      class="{{ if $active }}
                        bg-neutral-100 text-neutral-900 font-semibold
                      {{ end }} block rounded-md px-2 py-1.5 text-neutral-600 transition hover:bg-neutral-100 hover:text-neutral-900"
                      >{{ $linkText }}</a
                    >
                  </li>
                {{ end }}
              {{ end }}

            </ul>
          </details>
        </li>
      {{ end }}
    </ul>
  {{ else }}
    {{ $sections := site.Sections }}
    {{ if gt (len $sections) 0 }}
      <ul class="space-y-2">
        {{ range $sections.ByWeight }}
          {{ partial "notes/sidebar-section.html" (dict "Node" . "CurrentPath" $currentPath "Level" 0) }}
        {{ end }}
      </ul>
    {{ else }}
      <p class="px-2 text-sm text-neutral-500">
        `main` メニューにページを追加するとナビゲーションが表示されます。
      </p>
    {{ end }}
  {{ end }}
</div>
