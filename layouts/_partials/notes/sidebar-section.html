{{- $node := .Node -}}
{{- $currentPath := .CurrentPath -}}
{{- $level := .Level | default 0 -}}
{{- $nodePath := (urls.Parse $node.RelPermalink).Path -}}
{{- $isActive := eq $nodePath $currentPath -}}
{{- if $node.IsSection -}}
  {{- $childSections := where $node.Pages "IsSection" true -}}
  {{- $childPages := where $node.RegularPages ".Draft" "ne" true -}}
  {{- $isOpen := or $isActive (strings.HasPrefix $currentPath $nodePath) -}}
  {{- $childCount := add (len $childSections) (len $childPages) -}}
  <li>
    <details
      class="group overflow-hidden rounded-xl border border-neutral-200 bg-white/80"
      {{ if $isOpen }}open{{ end }}
    >
      <summary
        class="flex cursor-pointer items-center justify-between gap-2 px-3 py-2 text-neutral-800 transition hover:text-neutral-600 [&::-webkit-details-marker]:hidden"
      >
        <span class="flex items-center gap-2">
          <svg
            class="h-4 w-4 shrink-0 text-neutral-400 transition-transform duration-200 group-open:rotate-90"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9 18l6-6-6-6" />
          </svg>
          <a
            href="{{ $node.RelPermalink }}"
            class="flex-1 truncate text-left text-neutral-800 hover:text-neutral-600"
            >{{ $node.LinkTitle | default $node.Title }}</a
          >
        </span>
        {{ if gt $childCount 0 }}
          <span class="text-xs text-neutral-400">{{ $childCount }}ä»¶</span>
        {{ end }}
      </summary>
      {{ if gt $childCount 0 }}
        <ul class="space-y-1 border-t border-neutral-200 bg-white/70 py-2 pl-4">
          {{ range $childSections.ByWeight }}
            {{ partial "notes/sidebar-section.html" (dict "Node" . "CurrentPath" $currentPath "Level" (add $level 1)) }}
          {{ end }}
          {{ range $childPages.ByWeight }}
            {{ partial "notes/sidebar-section.html" (dict "Node" . "CurrentPath" $currentPath "Level" (add $level 1)) }}
          {{ end }}
        </ul>
      {{ end }}
    </details>
  </li>
{{- else -}}
  <li>
    <a
      href="{{ $node.RelPermalink }}"
      class="{{ if $isActive }}
        bg-neutral-100 text-neutral-900 font-semibold
      {{ end }} block rounded-md px-2 py-1.5 text-neutral-600 transition hover:bg-neutral-100 hover:text-neutral-900"
      >{{ $node.LinkTitle | default $node.Title }}</a
    >
  </li>
{{- end -}}
