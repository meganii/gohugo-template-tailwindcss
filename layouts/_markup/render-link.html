{{/* Render Hook
  - 内部の.mdファイルリンクは適切なRelPermalinkに変換し、発リンクとして記録
  - 通常の内部リンクも発リンクとして記録
  - 外部リンクは適切な属性を付与
  - アフィリエイトリンクは特別に処理
*/}}

{{- $isExternal := strings.HasPrefix .Destination "http" -}}
{{- $isMdFile := strings.HasSuffix .Destination ".md" -}}

{{- /* 1. 内部Markdownファイルへのリンク */ -}}
{{- if and (not $isExternal) $isMdFile }}
  {{- $url := urls.Parse .Destination -}}
  {{- $text := .Text | safeHTML -}}
  {{- with site.GetPage $url.Path -}}

    {{/* ★追加: リンク先のページが見つかった場合、発リンクとして記録 */}}
    {{- $.Page.Store.SetInMap "outgoingLinks" .RelPermalink .RelPermalink -}}


    <a
      data-rel="prefetch"
      class="text-neutral-900 hover:text-neutral-800 hover:underline"
      href="{{ .RelPermalink }}"
      >{{ $text }}</a
    >
  {{- end -}}

  {{- /* 2. アフィリエイトリンク (A8.net) */ -}}
{{- else if and $isExternal (strings.HasPrefix .Destination "https://px.a8.net/") -}}
  {{- range first 1 (where .Page.Site.Data.affiliate.affiliate.links "url" .Destination) -}}
    {{ .content | safeHTML }}
  {{- end -}}

  {{- /* 3. 通常のリンク（内部または外部） */ -}}
{{- else -}}

  {{/* ★追加: 内部リンクの場合、ページが存在するか確認して記録 */}}
  {{- if and (not $isExternal) (not (strings.HasPrefix .Destination "#")) -}}
    {{- with site.GetPage .Destination -}}
      {{/* リンク先がHugo管理下のページなら記録 */}}
      {{- $.Page.Store.SetInMap "outgoingLinks" .RelPermalink .RelPermalink -}}
    {{- end -}}
  {{- end -}}


  <a
    class="{{- if $isExternal -}}
      external-link
    {{- end }} text-neutral-900 hover:text-neutral-800 hover:underline"
    {{- if not $isExternal }}data-rel="prefetch"{{ end -}}
    href="{{ .Destination | safeURL }}"
    {{ with .Title }}title="{{ . }}"{{ end }}
    {{ if $isExternal }}target="_blank" rel="noopener"{{ end }}
  >
    {{ .Text | safeHTML }}
  </a>
{{- end -}}
